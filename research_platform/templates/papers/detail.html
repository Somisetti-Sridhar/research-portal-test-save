{% extends 'base.html' %}

{% block title %}{{ paper.title }} - Research Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>{{ paper.title }}</h4>
                <div>
                    {% if user.is_authenticated %}
                        <a href="{% url 'papers:bookmark' paper.pk %}" class="btn btn-outline-primary btn-sm">
                            {% if user_bookmark %}
                                <i class="fas fa-bookmark"></i> Bookmarked
                            {% else %}
                                <i class="far fa-bookmark"></i> Bookmark
                            {% endif %}
                        </a>
                        {% if paper.pdf_path %}
                            <a href="{% url 'papers:download' paper.pk %}" class="btn btn-success btn-sm">
                                <i class="fas fa-download"></i> Download
                            </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <p><strong>Authors:</strong> {{ paper.authors }}</p>
                <p><strong>Publication Date:</strong> {{ paper.publication_date }}</p>
                {% if paper.doi %}
                    <p><strong>DOI:</strong> {{ paper.doi }}</p>
                {% endif %}
                <p><strong>Categories:</strong> 
                    {% for category in paper.categories.all %}
                        <span class="badge bg-secondary">{{ category.name }}</span>
                    {% endfor %}
                </p>
                <p><strong>Uploaded by:</strong> {{ paper.uploaded_by.username }}</p>
                <p><strong>Views:</strong> {{ paper.view_count }} | <strong>Downloads:</strong> {{ paper.download_count }}</p>
                
                <h5>Abstract</h5>
                <p>{{ paper.abstract }}</p>

                <!-- Add this in the paper detail card body, after the abstract -->
                <div class="mt-3">
                    <a href="{% url 'chat:paper_chat' paper.pk %}" class="btn btn-info">
                        <i class="fas fa-comments"></i> Join Discussion
                    </a>
                {% if paper.pdf_path %}
                <a href="{% url 'papers:download' paper.pk %}" class="btn btn-success">
                <i class="fas fa-download"></i> Download PDF
                </a>
                {% endif %}
                </div>

                
                <div class="mt-3">
                    <a href="{% url 'chat:paper_chat' paper.pk %}" class="btn btn-info">
                        <i class="fas fa-comments"></i> Join Discussion
                    </a>
                </div>
            </div>
        </div>

        
        
        <!-- Ratings Section -->
        {% if user.is_authenticated %}
        <div class="card mt-4">
            <div class="card-header">
                <h5>Rate This Paper</h5>
            </div>
            <div class="card-body">
                {% if user_rating %}
                    <p>Your rating: {{ user_rating.rating }}/5</p>
                    <p>Your review: {{ user_rating.review_text }}</p>
                {% else %}
                    <form method="post" action="{% url 'papers:rate' paper.pk %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Rating</label>
                            {{ rating_form.rating }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Review (Optional)</label>
                            {{ rating_form.review_text }}
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Rating</button>
                    </form>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- All Ratings -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>User Ratings</h5>
            </div>
            <div class="card-body">
                {% for rating in ratings %}
                    <div class="mb-3">
                        <strong>{{ rating.user.username }}</strong>
                        <span class="badge bg-warning">{{ rating.rating }}/5</span>
                        <small class="text-muted">{{ rating.created_at|date:"M d, Y" }}</small>
                        {% if rating.review_text %}
                            <p class="mt-1">{{ rating.review_text }}</p>
                        {% endif %}
                    </div>
                {% empty %}
                    <p>No ratings yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Citations -->
        <div class="card">
            <div class="card-header">
                <h6>Citations ({{ citations.count }})</h6>
            </div>
            <div class="card-body">
                {% for citation in citations %}
                    <div class="mb-2">
                        <a href="{% url 'papers:detail' citation.citing_paper.pk %}">
                            {{ citation.citing_paper.title|truncatechars:50 }}
                        </a>
                    </div>
                {% empty %}
                    <p>No citations yet.</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Cited Papers -->
        <div class="card mt-3">
            <div class="card-header">
                <h6>References ({{ cited_papers.count }})</h6>
            </div>
            <div class="card-body">
                {% for citation in cited_papers %}
                    <div class="mb-2">
                        <a href="{% url 'papers:detail' citation.cited_paper.pk %}">
                            {{ citation.cited_paper.title|truncatechars:50 }}
                        </a>
                    </div>
                {% empty %}
                    <p>No references listed.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
